
\begin{center}
	\textbf{\large ГЛАВА 3 \\ РЕШЕНИЕ ОБРАТНОЙ ЗАДАЧИ КИНЕМАТИКИ}
\end{center}
\refstepcounter{chapter}


% \section*{}
\addcontentsline{toc}{chapter}{ГЛАВА 3}
\section{Общие требования к физической модели четырехногого робота}\label{C4_1}

Все четвероногие животные при движении сохраняют равновесие почти исключительно за счет динамической устойчивости. Изначально план чередования опорных и свободных положений ног заключался в переключении фаз по принципу ноги 1-4 опорная фаза, ноги 2-3 свободная, как показано на рисунке \ref{cycle_wanted}. Зелеными стрелками обозначены фазы свободного положения, а красными опорного. Однако, такой подход не совсем точен, хоть и вполне логичен.
\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.3\textwidth]{cycle_wanted}
		\caption{Смена опорных и свободных фаз.}
		\label{cycle_wanted}
	\end{center}
\end{figure}

В случае искусственных шагающих аппаратов походка может быть определена таким образом, чтобы центр тяжести аппарата постоянно находился внутри треугольника, вершинами которого являются конечности, находящиеся на данный момент времени в опорном положении (рисунок \ref{diagrama}). На практике эта возможность была реализована д-ром Такути из Научно-исследовательского центра проблем механики\cite{Nakano}. Под его руководством был разработан шагающий аппарат с четырьмя конечностями, у которых скорость движения в фазе восстановления подобрана так, что длительность этой фазы втрое меньше длительности каждой рабочей фазы. В результате в данный момент времени лишь одна нога робота находится в воздухе, а корпус опирается на три остальные, сохраняя тем самым статическую устойчивость. 

Показанные на рисунке \ref{diagrama} заштрихованные треугольники (так называемые опорные треугольники) образованы вершинами, которые соответствуют текущим точкам касания опорной поверхности какими-либо тремя из четырех ног робота. Например, в состоянии, соответствующем рисунку \ref{diagrama}, опоры касаются три ноги - А, В, С, а четвертая нога - D, будучи в фазе восстановления, находится в воздухе. Для обеспечения статической устойчивости принципиально важное значение имеет правильный выбор порядка чередования (сдвиг фаз) четырех ног в процессе движения аппарата. В момент времени, отраженный на диаграмме 1, нога В только что коснулась земли и сейчас занимает опорное положение, нога А также касается земли, но находится уже во второй половине своей рабочей фазы, а нога С - еще в первой половине собственной рабочей фазы. Нога D, находящаяся в момент наблюдения в воздухе, быстро заканчивает фазу восстановления, и к моменту времени, которому соответствует диаграмма 2, она уже опускается на землю, переходя в опорное положение. К этому моменту нога А завершила свою рабочую фазу и, оторвавшись от земли, переходит в фазу восстановления; нога В находится в первой половине, а нога С - во второй половине своих рабочих фаз. Аналогично в следующие моменты времени, которым соответствуют диаграммы 3 и 4, в фазу восстановления переходят друг за другом нога С и нога В. 

При таком порядке чередования ног в любой момент времени, когда одна из ног робота находится в фазе восстановления, центр тяжести аппарата обязательно будет лежать внутри треугольника, образованного тремя ногами, находящимися не в рабочей фазе (опирающимися на землю).

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.3\textwidth]{diagrama}
		\caption{Смена опорных и свободных фаз с учетом тяжести}
		\label{diagrama}
	\end{center}
\end{figure}
\newpage
\section{Задача синтеза походки четырехногого шагающего робота}\label{C3_1}
Процесс движения шагающего аппарата, в котором осуществляется работа ног, можно определить как ходьбу. В ходе данного процесса каждая из ног может находиться в одном из двух основных состояний, отличающихся друг от друга принципиально.

В процессе ходьбы, ноги шагающего аппарата попеременно занимают то опорное, то свободное положения, причем в течение одного цикла каждая нога занимает то и другое положение один раз. Последовательность, в которой при ходьбе происходит чередование опорного и свободного положений всех ног аппарата, определяет конкретный способ его передвижения или его походку. Последовательность чередований ног за один период называется циклом ходьбы, а расстояние, которое проходит аппарат за один цикл, --- шагом\cite{Nakano}.
Движения, совершаемые любой из ног при чередовании опорного и свободного положений в процессе ходьбы, можно упрощенно разделить на фазу поступательного перемещения и фазу восстановления. В простейшем случае переход от первой фазы ко второй может осуществляться за счет движений ноги вверх-вниз строго по вертикали. Однако энергия шагающего аппарата будет расходоваться более эффективно, если в течение фазы восстановления нога будет перемещаться по некоторой кривой. Одна из возможных форм криволинейной траектории стопы относительно корпуса показана на рис \ref{movement}.

Разделим предстоящую задачу формирования походки на два этапа:

\begin{enumerate} 
	\item Опорное положение (перенос корпуса) --- в это время нога касается поверхности и служит опорной для корпуса аппарата;
	\item Свободное положение (перенос ноги) --- в это время нога находится над поверхностью и готовится к выполнению опорных функций на следующем шаге.
\end{enumerate}
\newpage
\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.8\textwidth]{movement}
		\caption{Траектория относительно корпуса в фазах опорного и свободного положения ноги во время движения}
		\label{movement}
	\end{center}
\end{figure}

\section{Решение задачи для одной ноги. Опорное положение}\label{C3_2}
Рассмотрим подробно первый этап. Нам известны длины звеньев $L_{1}$ и $L_{2}$, а также высота от поверхности земли до корпуса $h_{\text{корп}}$. 
Начальные условия для шага:
\begin{equation}
	\begin{array}{l}
		X = +X_{\text{ш}},
		\\
		Y = 0.
	\end{array}
\end{equation}
Конечные условия для шага:
\begin{equation}
	\begin{array}{l}
		X = -X_{\text{ш}},
		\\
		Y = 0,
	\end{array}
	\label{gran_step}
\end{equation}
где $X_{\text{ш}}$ --- максимальное значение для переноса корпуса во время опорной фазы, $-$$X_{\text{ш}}$ --- максимальное значение для переноса ноги во время свободной фазы. Отрезок от ($-$$X_{\text{ш}}$) до $X_{\text{ш}}$ --- полная ширина шага (см. Приложение А и рисунок \ref{workArea}).

Таким образом, положение ноги в начальный момент времени можно отобразить согласно рисунку \ref{Plus_step}.
\newline
\begin{figure}[h]
	\begin{center}
		\includegraphics[width=0.6\textwidth]{Plus_step}
		\caption{Положения ноги относительно корпуса в начальный момент времени}
		\label{Plus_step}
	\end{center}
\end{figure}

В данной задаче необходимо определить закон изменения углов двигателей в бедре $\gamma$ и колене $\theta$ для положительного переноса корпуса по оси $X$. Исходя из рисунка \ref{Plus_step}, получим следующие уравнения для $\gamma$:
\begin{equation}
	\begin{array}{l}
		\phi+\gamma-\displaystyle\frac{\pi}{2} = \arcctg\left({\displaystyle\frac{+X_{\text{ш}}}{h_{\text{корп}}}}\right), 
		\\
		\gamma = \displaystyle\frac{\pi}{2}+ \arcctg\left({\displaystyle\frac{+X_{\text{ш}}}{h_{\text{корп}}}}\right) - \phi.
	\end{array}
\end{equation}
Соответственно для $\theta$ получим:
\begin{equation}
	\begin{array}{l}
		\theta = 2 \arcsin\left({\displaystyle\frac{l_{\text{гип}}}{2l_{1}}}\right),	
	\end{array}			
\end{equation}
где вспомогательный угол $\phi$ и длину $l_{\text{гип}}$ можно найти как:
\begin{equation}
	\begin{array}{l}
		\phi=\arccos\left({\displaystyle\frac{l_{\text{гип}}}{2l_{1}}}\right),
		\\
		l_{\text{гип}}=\sqrt{x^{2}_{\text{ш}}+h^{2}_{\text{корп}}}.
	\end{array}
\end{equation}

Далее рассмотрим конечный момент времени, где условия шага описаны формулой \ref{gran_step}. Конфигурация ноги в таком случае примет положение, которое отображено на рисунке \ref{minus_step}.
\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.6\textwidth]{minus_step}
		\caption{Положения ноги относительно корпуса в конечный момент времени}
		\label{minus_step}
	\end{center}
\end{figure}

Определим значения, которые принимают $\gamma$, $\theta$ и вспомогательный угол $\alpha$ в конечный момент времени переноса корпуса.
\begin{equation}
	\begin{array}{l}
		\gamma= \displaystyle\frac{\pi}{2} - \phi - \arctg\left({\displaystyle\frac{-X_{\text{ш}}}{h_{\text{корп}}}}\right) =
		\\
		=\displaystyle\frac{\pi}{2}-\arccos\left({\displaystyle\frac{l_{\text{гип}}}{2l_{1}}}\right)+\arctg\left({\displaystyle\frac{-X_{\text{ш}}}{h_{\text{корп}}}}\right),
		\\
		\theta = 2 \arcsin\left({\displaystyle\frac{l_{\text{гип}}}{2l_{1}}}\right),
		\\
		\alpha = \arctg\left({\displaystyle\frac{-X_{\text{ш}}}{h_{\text{корп}}}}\right).
	\end{array}
\end{equation}

Заметим, что законы изменения углов двигателей отличаются только знаком $X_{\text{ш}}$. Таким образом, определим общий закон изменения углов в зависимости от $X_{\text{ш}}$. Иначе говоря получим решение обратной задачи кинематики для одного шага робота, но без переноса стопы:
\begin{equation}
	\begin{array}{l}
		\theta(x_{\text{ш}}) = 2 \arcsin\left({\displaystyle\frac{\sqrt{x^{2}_{\text{ш}}+h^{2}_{\text{корп}}}}{2l_{1}}}\right),
		\\
		\gamma(x_{\text{ш}})= \displaystyle\frac{\pi}{2} -\arccos\left({\frac{\sqrt{x^{2}_{\text{ш}}+h^{2}_{\text{корп}}}}{2l_{1}}}\right) + \arctg\left({\displaystyle\frac{X_{\text{ш}}}{h_{\text{корп}}}}\right),
		\\
		l_{\text{гип}}=\sqrt{x^{2}_{\text{ш}}+h^{2}_{\text{корп}}}.
	\end{array}
	\label{finalEQ}
\end{equation}

Напишем небольшой скрипт на языке Python, чтобы построить графики изменения углов в двигателях в зависимости от ширины шага $X_{\text{ш}}$:
%\newpage
\begin{python}
	
 	def callculate_step(x_range_step,height):
	
		y_step=0
		height_slew = np.sqrt(x_range_step**2+(height-y_step)**2)
		hip_step = 0.5*np.pi - np.arccos(height_slew/(2*.l1))+np.arctan(x_range_step/(height-y_step))
		knee_step = 2*np.arcsin(height_slew/(2*.l1))
	
	return np.rad2deg(hip_step), np.rad2deg(knee_step)
\end{python}

Получим следующие результаты для значений $X_{\text{ш}}$ от $-$40 мм до 40 мм с шагом 1 мм. Отобразим их на рисунке \ref{ideal_kin}. Для этого вызовем функцию в исполнительном файле: 
\newpage

\begin{python}
	import numpy as np
	import matplotlib.pyplot as plt
	
	x_range_step = np.arange(40,-40,-10)
	hip_step = np.zeros(np.size(x_range_step))
	knee_step = np.zeros(np.size(x_range_step))

	for i in range(x_range_step):
		hip,knee = callculate_step(x_range_step[i])
		hip_step[i] = hip
		knee_step[i] = knee
	
	plt.plot(hip_step)
	plt.plot(knee_step)
	
\end{python}

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.9\textwidth]{ideal_kin}
		\caption{График изменения углов бедра и колена во времени}
		\label{ideal_kin}
	\end{center}
\end{figure}

\newpage 
Проверим, что в момент фазы опорного положения ноги, ее высота не изменялась и задача о положении ноги для переноса корпуса решена верно. Если задача решена верно, то результатом уравнения \ref{h_step}, при построении графика должна быть горизонтальная прямая (рисунок \ref{H} ), по значению равная $h_{\text{корп}}$, которая означает, что крайняя точка ноги (стопа) находилась на максимальном заданном расстоянии от корпуса и не изменялась в течение фазы опорного положения:
\begin{equation}
	\begin{array}{l}
		H = l_{1}\cos({\frac{\pi}{2}-\gamma}) + l_{2}\sin({\theta-\gamma}).
	\end{array}
	\label{h_step}
\end{equation}
\newline
\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.9\textwidth]{H}
		\caption{График высоты стопы при опорном положении}
		\label{H}
	\end{center}
\end{figure}
\newpage
\section{Решение задачи для одной ноги. Свободное положение}\label{C3_3}
Фаза переноса --- это один из ключевых этапов движения четырехногого робота, который происходит между фазами опоры. Во время переноса конечность робота находятся в воздухе и перемещается в новую позицию для следующего шага. Эта фаза требует от робота сбалансированности и точности движений, чтобы избежать падений и обеспечить плавность передвижения. Иначе говоря, фазу переноса можно рассматривать как переходный этап между двумя фазами опоры, в котором робот готовится к следующему шагу.

Рассмотрим подробно второй этап. Нам известны длины звеньев $L_{1}$, $L_{2}$ и высота от поверхности земли до корпуса $h_{\text{корп}}$. 
Условия для свободного положения включают в себя два краевых: начальное и конечное, а также серединное.
\newline
Начальные условия:
\begin{equation}
	\begin{array}{l}
		X = -X_{\text{ш}},
		\\
		Y = 0.
	\label{gran_skip1}
	\end{array}
\end{equation}
Конечные условия:
\begin{equation}
	\begin{array}{l}
		X = +X_{\text{ш}},
		\\
		Y = 0.
	\label{gran_skip2}
	\end{array}
\end{equation}
Серединные условия:
\begin{equation}
	\begin{array}{l}
		X = 0,
		\\
		Y = h_{\text{под}},
	\end{array}
	\label{gran_skip3}
\end{equation}
где $X_{\text{ш}}$ --- максимальное значение для переноса корпуса во время опорной фазы, $-$$X_{\text{ш}}$ --- максимальное значение для переноса ноги во время свободной фазы. Отрезок от $-$$X_{\text{ш}}$ до $X_{\text{ш}}$ --- полная ширина шага (см. Приложение А и рисунок \ref{workArea}). $h_{\text{под}}$ --- высота подъема ноги, ограничения на которую необходимо найти.

Рассмотрим кинематическую схему на рисунке \ref{skip_traj}. На нем изображена конфигурация ноги в трех положениях, которые описывают условия \ref{gran_skip1},\ref{gran_skip2},\ref{gran_skip3}. 
\newpage
\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.6\textwidth]{skip_traj}
		\caption{Последовательность переноса стопы в свободном положении}
		\label{skip_traj}
	\end{center}
\end{figure}

Перенос стопы по дуге окружности не является оптимальным решением, однако нам неизвестны динамические характеристики робота, так как это прототип. Следовательно, на начальном этапе достаточно выбрать удобную для реализации траекторию без оптимизации. В таком случае  выполнять оптимизацию предпочтительнее на завершающем этапе работы. Конечно, существуют алгоритмы поиска таких траекторий, где рассчет переноса стопы выполняется с опорой на машинное обучение с подкреплением, что требует отдельного исследования\cite{r_learning}. В настоящей работе движение происходит на ровной поверхности, таким образом с помощью регулирования радиуса $r$ создадим механизм, позволяющий регулировать высоту переноса стопы $h_{\text{под}}$, которая будет реализуема для заданной конфигурации робота, с учетом известных длин звеньев $l_{1}$, $l_{2}$ и высоты $h_{\text{корп}}$. Исходя из известных данных, вполне справедливо, что радиус можно найти как:
\begin{equation}
	\begin{array}{l}
		r=\sqrt{x^{2}_{\text{ш}}+\Delta^{2}} = \Delta + h_{\text{под}},
	\end{array}
	\label{radius}
\end{equation}
где $x_{\text{ш}}$ - задаваемая ширина шага от $-$$X_{\text{ш}}$ до $+X_{\text{ш}}$, $\Delta$ --- расстояние, которым контролируется положение центра окружности по высоте.
\newline
Таким образом высота подъема стопы $h_{\text{под}}$ определяется из уравнения:
 \begin{equation}
 	\begin{array}{l}
 		h_{\text{под}}(x_{\text{ш}})=\sqrt{r^{2}-x^{2}_{\text{ш}}}-\Delta,
 		\\
 		\Delta = \sqrt{r^{2}-x^{2}_{\text{ш}}},
 	\end{array}
 	\label{hpod}
 \end{equation}
 где ограничение на высоту подъема ноги вводится как:
 \noindent $$r>x_{\text{ш}}$$
 
 Тогда с учетом найденного $h_{\text{под}}$, определим законы изменения углов в двигателях для бедра и колена соответственно:
 
 \begin{equation}
 	\begin{array}{l}
 		\theta(x_{\text{ш}}) = 2 \arcsin\left({\displaystyle\frac{\sqrt{x^{2}_{\text{ш}}+h^{2}_{\text{корп}}-h^{2}_{\text{под}}}}{2l_{1}}}\right),
 		\\
 		\gamma(x_{\text{ш}})= \displaystyle\frac{\pi}{2} -\arccos\left({\frac{\sqrt{x^{2}_{\text{ш}}+h^{2}_{\text{корп}}-h^{2}_{\text{под}}}}{2l_{1}}}\right) + \arctg\left({\frac{X_{\text{ш}}}{h_{\text{корп}}}}\right),
 		\\
 		l_{\text{гип}}=\sqrt{x^{2}_{\text{ш}}+h^{2}_{\text{корп}}},
 		\\
 		h_{\text{под}}(x_{\text{ш}})=\sqrt{r^{2}-x^{2}_{\text{ш}}}-\Delta,
 		\\
 		\Delta = \sqrt{r^{2}-x^{2}_{\text{ш}}}.
 	\end{array}
 	\label{skip_eq}
 \end{equation}
 
Аналогично с пунктом \ref{C3_2} напишем скрипт на языке Python, чтобы получить графики изменения углов в двигателях в зависимости от ширины шага $X_{\text{ш}}$:

 \begin{python}
	def callculate_skip(x_range_skip,min_delta,height,r):
		delta = np.sqrt(r**2-min_delta**2)
		y_skip = np.sqrt((r**2) - (x_range_skip**2)) - delta
		height_slew = np.sqrt(x_range_skip**2+(height-y_skip)**2)
		
		hip_skip = 0.5*np.pi - np.arccos(height_slew/(2*l1))+np.arctan(x_range_skip/(height-y_skip))
		knee_skip = 2*np.arcsin(height_slew/(2*l1))
		
		return np.rad2deg(hip_skip),np.rad2deg(knee_skip)
\end{python}

C учетом результатов на рисунке \ref{ideal_kin}, получим графики углов $\theta$ и $\gamma$ при переносе стопы для значений $X_{\text{ш}}$ от $-$40 мм до 40 мм с шагом 1 мм, высотой $h_\text{корп}$ = 130 мм и $r$ = 100 мм. Отобразим их на рисунке \ref{full_traj}. Для этого добавим функцию в исполнительный файл, описанный выше в пункте \ref{C3_2}:

\begin{python}
	import numpy as np
	import matplotlib.pyplot as plt
	
	x_range_step = np.arange(40,-40,-10)
	x_range_skip = np.arange(-40,40,10)
	r= 100
	height = 130
	min_delta = x_range_skip[0]
	hip = []
	knee = []
	
	for i in range(x_range_step):
		hip,knee = callculate_step(x_range_step[i],height)
		hip[i] = hip
		knee[i] = knee
	
	for i in range(x_range_skip):
		hip,knee = callculate_skip(x_range_skip,min_delta,height,r)
		hip[i] = hip
		knee[i] = knee
	
	plt.plot(hip)
	plt.plot(knee)
\end{python}

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.8\textwidth]{full_traj}
		\caption{Изменение углов двигателей за полный цикл одного шага}
		\label{full_traj}
	\end{center}
\end{figure}
%\noindent
%\newpage
Проведем проверку, аналогичную в пункте \ref{C2_2}. Если задача решена верно, то мы получим результат схожий с рисунком \ref{movement}. Для этого воспользуемся формулой \ref{h_step}. Полученный график отображен на рисунке \ref{full_cycle}
\newpage
\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.7\textwidth]{full_cycle}
		\caption{Траектория стопы относительно корпуса за полный шаг}
		\label{full_cycle}
	\end{center}
\end{figure}

\newpage